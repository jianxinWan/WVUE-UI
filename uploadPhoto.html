<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <style>
    *{
      margin: 0;
      padding: 0;
    }
    .mark{
      position:absolute;
      height:200px;
      width:200px;
      top: 0 ;
      left:0;
      border:1px solid #50bfff;
      cursor:move;
    }
    #c1{
      border:1px solid #ccc;
    }
  </style>
</head>
<body>
  <canvas id="c1"></canvas>
  <div class="mark" id="mark"></div>
  <canvas id="c3"></canvas>
  <script>
  let canvas1 = document.getElementById("c1");
  let oMark = document.getElementById("mark");
  let canvas3= document.getElementById("c3");
  canvas1.height = 300;
  canvas1.width=300;
  canvas3.height=200;
  canvas3.width=200;
  oMark.addEventListener('mousedown',function(event){
    let ev = event || window.event;
    let relaX = ev.clientX - this.offsetLeft;
    let relaY = ev.clientY - this.offsetTop;
    let leftMax = canvas1.offsetWidth - oMark.offsetWidth;
    let topMax = canvas1.offsetHeight -oMark.offsetHeight;
    // 获取当前鼠标位置，减去与div的相对位置得到当前div应该被拖拽的位置
    document.onmousemove = function(ev) {
      ev = ev || window.event;
      let left = ev.clientX - relaX;
      let top = ev.clientY - relaY;
      //限制移动区域
      left = left<=0 ? 0 : left;
      top = top <=0 ? 0:top;
      left =left>=leftMax?leftMax:left;
      top =top>=topMax?topMax:top;
      oMark.style.left = left + 'px';
      oMark.style.top = top + 'px';
      let cxt1 = canvas1.getContext("2d");
      let img = new Image();
      img.src = "./static/img/pcinput.png";
      let srcX = oMark.offsetLeft-canvas1.getBoundingClientRect().left;
      let srcY = oMark.offsetTop-canvas1.getBoundingClientRect().top;
      console.log(canvas1.getBoundingClientRect().left,canvas1.getBoundingClientRect().top);
//      console.log(srcX,srcY);
      let sWidth = oMark.offsetWidth;
      let sHeight = oMark.offsetHeight;
      let canvas2 = document.createElement("canvas");
      let cxt2=canvas2.getContext("2d");
      img.onload = function(){
        cxt1.drawImage(img,0,0,canvas1.width,canvas1.height);
        let dataImg = cxt1.getImageData(srcX,srcY,sWidth,sHeight);
        canvas2.width = sWidth;
        canvas2.height = sHeight;
        cxt2.putImageData(dataImg,0,0,0,0,canvas2.width,canvas2.height);
        let img2 = canvas2.toDataURL("image/png");
        let cxt3=canvas3.getContext("2d");
        let img3 = new Image();
        img3.src = img2;
        img3.onload  = function(){
          cxt3.drawImage(img3,0,0,canvas3.width,canvas3.height)
        }
      }
    };
    document.onmouseup = function() {
      document.onmousemove = null;
      document.onmouseup = null;
    }
  },false);
</script>
</body>
</html>
